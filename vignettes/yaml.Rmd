---
title: "YAML removal and classification recipes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{yaml}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The processing of search queries is controlled by rules that are stored in [YAML](https://yaml.org/) files. Their structure is documented here.

# File

The highest unit of structure is the file. You can have just one, or you can have more. Splitting many rules into multiple files can be neater and can make it easier for multiple people to collaborate on a project. 

In addition, you can only apply certain files at a time. This will split your query classification into multiple phases, which will be faster and more transparent to process.

# Recipes

The file consists of a list of recipes.

```{yaml}
- [recipe]
- [recipe]
- [recipe]
...
```

There are two basic groups of recipes: removal and classification.

## Removal recipes

## Classification recipes

Each classification recipe consists of several fields and a set of several (here three) recipes looks like this:

```{yaml}
- type: flag
  name: flag_name
  patterns:
  - aaa
  - ccc
- type: label
  name: label_name_1
  patterns:
  - aaa
  - ddd
- type: label
  name: label_name_2
  values:
  - value: A
    patterns: aaa
  - value: B
    patterns:
    - bbb
    - bb bb
```

Note that:

- All recipes have *type*, *name* and *patterns* fields.
- The *type* field specifies the type of the classification dimension (see below).
- The *name* field specifies the name of the classification dimension. In the resulting table of classified queries, it becomes the column header.
- The *patterns* field is a list of regular expressions. If at least one of them applies to a query, the query is classified in that dimension.

### Recipe of the type *flag*

The following example recipe of type *flag* creates a column of logical type (boolean) named *flag_name* in the resulting table of classified queries. Queries that match the regular expression `aaa` or `ccc` will be given the value `TRUE`, while queries that match neither of these regular expressions will be given the value `FALSE`.

```{yaml}
- type: flag
  name: flag_name
  patterns:
  - aaa
  - ccc
```

If a single regular expression is sufficient to specify the queries, you can write the entire recipe abbreviated as follows according to YAML rules. Te following example works the same as the one above:

```{yaml}
- type: flag
  name: flag_name
  patterns: aaa|ccc
```

If you want to reverse the logic and flag queries that do not match certain regular expressions with `TRUE`, use the *except* field instead of the *patterns* field. In this example the queries that do not match the regular expressions `aaa` or `ccc` will be marked `TRUE`.

```{yaml}
- type: flag
  name: flag_name
  except: aaa|ccc
```

The *patterns* and *exept* fields can be combined with each other. The following recipe marks `TRUE` only those queries that match the regular expressions `aaa` or `ccc` and do not match the regular expression `bbb`.

```{yaml}
- type: flag
  name: flag_name
  patterns:
  - aaa
  - ccc
  except: bbb
```

In special cases, a more complex rule may be needed. Suppose you want to mark `TRUE` queries that match the regular expression `aaa` and do not match the regular expression `bbb`, and also queries that match the regular expression `ccc` and do not match the regular expression `ddd`. You must do this with two recipes:

```{yaml}
- type: flag
  name: flag_name
  patterns: aaa
  except: bbb
- type: flag
  name: flag_name
  patterns: ccc
  except: ddd
```

Alternative:

```{yaml}
- type: flag
  name: flag_name
  patterns: 
  - aaa
  - except: 
    - bbb
  - ccc
  - except:
    - ddd
```

### Recipe of the type *label*

```{yaml}
- type: flag
  name: flag_name
  negate: no
  patterns:
  - aaa
  - ccc
- type: label
  name: label_name_1
  patterns:
  - aaa
  - ddd
- type: label
  name: label_name_2
  values:
  - value: A
    patterns: aaa
  - value: B
    patterns:
    - bbb
    - bb bb
```


```{r}
library(keywordr)
```

```{r}
readr::read_lines(skip_empty_rows = TRUE, "
- type: flag
  name: flag_name
  rules:
  - patterns:
    - aaa
    - bbb
    except:
    - xxx
    - yyy
  - patterns:
    - ccc
    - ddd
") |> 
  stringr::str_c(collapse = "\n") |> 
  yaml::yaml.load()
```

Úplnný YAML

```{r echo=FALSE, results='asis'}
print_yaml <- function(x) {
  yaml <- yaml::as.yaml(x)
  cat("\n\n```{yaml}\n", yaml, "```\n\n", sep = "")
}

list(
  list(
    type = "remove",
    rules = list(
      match = c("rrr", "sss"),
      except = c("aaa", "bbb")
    )
  ),
  list(
    type = "include",
    rules = list(
      match = c("rrr", "sss"),
      except = c("aaa", "bbb")
    )
  ),
  list(
    type = "flag",
    name = "flag_name",
    rules = list(
      list(
        match = c("aaa", "bbb"),
        except = c("xxx", "yyy")
      ),
      list(
        match = c("ccc", "ddd")
      )
    )
  ),
  list(
    type = "label",
    name = "label_name",
    rules = list(
      list(
        match = c("aaa", "bbb"),
        except = c("xxx", "yyy")
      ),
      list(
        match = c("ccc", "ddd")
      )
    )
  ),
  list(
    type = "label",
    name = "label_name_2",
    values = list(
      list(
        value = "A-B",
        rules = list(
          list(
            match = c("aaa", "bbb"),
            except = c("xxx", "yyy")
          )
        )
      ),
      list(
        value = "C-D",
        rules = list(
          list(
            match = c("ccc", "ddd"),
            except = c("xxx", "yyy")
          )
        )
      )
    )
  )
) |> 
  print_yaml()
```

Zkrácený YAML, pokud je jen jedno pravidlo

```{r echo=FALSE, results='asis'}
list(
  list(
    type = "remove",
    match = c("rrr", "sss"),
    except = c("aaa", "bbb")
  ),
  list(
    type = "include",
    match = c("rrr", "sss"),
    except = c("aaa", "bbb")
  ),
  list(
    type = "flag",
    name = "flag_name",
    match = c("aaa", "bbb"),
    except = c("xxx", "yyy")
  ),
  list(
    type = "label",
    name = "label_name",
    match = c("aaa", "bbb"),
    except = c("xxx", "yyy")
  ),
  list(
    type = "label",
    name = "label_name_2",
    values = list(
      value = "A-B",
      rules = list(
        list(
          match = c("aaa", "bbb"),
          except = c("xxx", "yyy")
        )
      ),
      value = "C-D",
      rules = list(
        list(
          match = c("ccc", "ddd"),
          except = c("xxx", "yyy")
        )
      )
    )
  )
) |> 
  print_yaml()
```

Nejjednodušší YAML- jen jedno pravidlo, jen jeden pattern, žádný except

```{r echo=FALSE, results='asis'}
list(
  list(
    type = "remove",
    match = "rrr"
  ),
  list(
    type = "include",
    match = "sss"
  ),
  list(
    type = "flag",
    name = "flag_name",
    match = "aaa"
  ),
  list(
    type = "label",
    name = "label_name",
    match = "aaa"
  ),
  list(
    type = "label",
    name = "label_name_2",
    values = list(
      list(
        value = "A-B",
        match = "aaa"
      ),
      list(
        value = "C-D",
        match = "ccc"
      )
    )
  )
) |> 
  print_yaml()
```
